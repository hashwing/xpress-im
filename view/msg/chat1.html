<!DOCTYPE html>
<html lang="zh_CN">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>èŠå¤©çª—å£</title>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.imageviewer.css">
		<link rel="stylesheet" type="text/css" href="../../css/chat-im.css">
	</head>

	<body>
		<div class="mui-content">
			<div class="mui-scroll-wrapper">
				<div class="mui-scroll" id="pullrefresh">
					<!-- èŠå¤©å†…å®¹åˆ—è¡¨ -->
					<div class="im-chat-main">
						<ul id="msg_list">
						</ul>
						<div id="msg_end" style="height:0px;"></div>
					</div>

				</div>
			</div>
			<!-- åº•éƒ¨ -->
			<footer>
				<div class="footer-left">
					<i class="mui-icon chat-icon chat-icon-voice"></i>
				</div>
				<div class="footer-center">
					<textarea id="msg_text" type="text" class="input-text"></textarea>
					<div class="mui-btn mui-btn-outlined voice-btn">æŒ‰ä½ è¯´è¯</div>
				</div>
				<div class="footer-right">
					<i class="mui-icon chat-icon chat-icon-face" style="margin-right: 0.2rem; padding-left: 10px;"></i>
					<i class="mui-icon chat-icon chat-icon-add-more" style="width: 46px;"></i>
					<div class="mui-btn mui-btn-success mui-hidden" id="sendMessage">å‘é€</div>
				</div>
			</footer>

			<!--è¡¨æƒ…å†…å®¹-->
			<div id="face-content" class="mui-content face-content">
				<div id="Gallery" class="mui-slider">
					<div class="mui-slider-group" id="faces">
						<div class="mui-slider-item">
							<ul class="clear face-list">

							</ul>
						</div>
					</div>
					<div class="mui-slider-indicator">
						<div class="mui-indicator mui-active"></div>
						<div class="mui-indicator"></div>
						<div class="mui-indicator"></div>
						<div class="mui-indicator"></div>
					</div>
				</div>
			</div>

			<!-- æ›´å¤šå¼¹å‡ºå†…å®¹ -->
			<div class="mui-content more-content">
				<ul class="mui-table-view mui-grid-view mui-grid-9">
					<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3" data-type="images" id="getImg">
						<span class="mui-icon mui-icon-image"></span>
						<div class="mui-media-body">å›¾ç‰‡</div>
					</li>
					<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
						<span class="mui-icon mui-icon-eye"></span>
						<div class="mui-media-body">å°è§†é¢‘</div>
					</li>
					<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
						<span class="mui-icon mui-icon-location"></span>
						<div class="mui-media-body">ä½ç½®</div>
					</li>
					<li class="mui-table-view-cell mui-media mui-col-xs-3 mui-col-sm-3">
						<span class="mui-icon mui-icon-contact"></span>
						<div class="mui-media-body">åç‰‡</div>
					</li>
				</ul>
			</div>
		</div>
		<!--</div>-->
	</body>
	<script src="../../js/jquery-2.2.4.min.js"></script>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.imageViewer.js"></script>
	<script src="../../js/data/vg.js"></script>
	<script src="../../js/data/db.js"></script>
	<script type="text/javascript">
		var emjs = [
			"ğŸ˜‚", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ‘¿", "ğŸ˜‰", "ğŸ˜Š", "â˜º", "ğŸ˜Œ", "ğŸ˜", "ğŸ˜", "ğŸ˜“", "ğŸ˜’", "ğŸ˜”", "ğŸ˜–", "ğŸ˜˜", "ğŸ˜š", "ğŸ˜œ", "ğŸ˜", "ğŸ˜",
			"ğŸ˜ ", "ğŸ˜¡", "ğŸ˜¢", "ğŸ˜£", "ğŸ˜¥", "ğŸ˜¨", "ğŸ˜ª", "ğŸ˜­",
			"ğŸ˜°", "ğŸ˜±", "ğŸ˜²", "ğŸ˜³", "ğŸ˜·", "ğŸ™ƒ", "ğŸ˜‹", "ğŸ˜—", "ğŸ˜›", "ğŸ¤‘", "ğŸ¤“", "ğŸ˜", "ğŸ¤—", "ğŸ™„", "ğŸ¤”", "ğŸ˜©", "ğŸ˜¤", "ğŸ¤", "ğŸ¤’",
			"ğŸ˜´", "ğŸ‘¯", "ğŸ‘¶", "ğŸ‘¦", "ğŸ‘§", "ğŸ‘¨", "ğŸ‘©", "ğŸ‘«",
			"ğŸ‘±", "ğŸ‘²", "ğŸ‘³", "ğŸ‘´", "ğŸ‘µ", "ğŸ‘®", "ğŸ‘·", "ğŸ‘¸", "ğŸ’‚", "ğŸ‘¼", "ğŸ…", "ğŸ‘»", "ğŸ’©", "ğŸ’€", "ğŸ‘½", "ğŸ‘¾", "ğŸ’", "ğŸ™…", "ğŸ™†",
			"ğŸ’†", "ğŸ’‡", "ğŸ™‹", "ğŸ™‡", "ğŸ’‘", "ğŸ’", "ğŸ™Œ", "ğŸ‘", "ğŸ‘‚", "ğŸ‘€",
			"ğŸ‘ƒ", "ğŸ‘„", "ğŸ’‹", "ğŸ’…", "ğŸ‘‹", "ğŸ‘", "ğŸ‘", "ğŸ‘†", "ğŸ‘‡", "ğŸ‘ˆ", "ğŸ‘‰", "ğŸ‘Œ", "âœŒ", "ğŸ‘Š", "âœŠ", "ğŸ’ª", "ğŸ‘", "ğŸ™"
		];
		var msgList = document.getElementById("msg_list");
		var boxMsgText = document.getElementById("msg_text");

		// 		mui('.mui-scroll-wrapper').scroll({
		// 			deceleration: 0.0005 //flick å‡é€Ÿç³»æ•°ï¼Œç³»æ•°è¶Šå¤§ï¼Œæ»šåŠ¨é€Ÿåº¦è¶Šæ…¢ï¼Œæ»šåŠ¨è·ç¦»è¶Šå°ï¼Œé»˜è®¤å€¼0.0006
		// 		});
		var firstLoad = true

		function pullupRefresh() {
			var ws = plus.webview.currentWebview();
			var sid = ws.sid;
			var msgsSuccess = function(e) {
				if (e.length==0){
					mui.toast("æ²¡æœ‰æ›´å¤šäº†~")
				}
				for (var i = 0; i < e.length; i++) {
					msg = {
						sender: e[i].fromJid,
						type: 'text',
						content: e[i].body,
						time: e[i].time
					}
					msgs.unshift(msg);

					bindMsgs(firstLoad);
				}
				firstLoad = false
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh()
			}
			findMsg(sid, msgs.length, msgsSuccess);
		}

		mui.init({
			pullRefresh: {
				container: "#pullrefresh", //ä¸‹æ‹‰åˆ·æ–°å®¹å™¨æ ‡è¯†ï¼ŒquerySelectorèƒ½å®šä½çš„cssé€‰æ‹©å™¨å‡å¯ï¼Œæ¯”å¦‚ï¼šidã€.classç­‰
				down: {
					style: 'circle',
					//auto: true,
					callback: pullupRefresh
				}
			}
		});
		(function($) {
			//åˆå§‹åŒ–å›¾ç‰‡æµè§ˆæ’ä»¶
			var imageViewer = new $.ImageViewer('.msg-content-image', {
				dbl: false
			});
			//			var slider = document.getElementById('Gallery');
		})(mui);

		$(function() {
			//
			var html = '';
			var len = parseInt(emjs.length / 4)
			console.log(len)
			for (var j = 0; j < 4; j++) {
				var itemhtml = '';
				for (var i = j * len; i < (j + 1) * len; i++) {
					itemhtml += '<li title="' + emjs[i] + '">' + emjs[i] + '</li>';
				}
				html += '<div class="mui-slider-item">' +
					'<ul class="clear face-list">' +
					itemhtml +
					'</ul>' +
					'</div>'
			}
			$("#faces").html(html)
			//è¾“å…¥æ¡†äº‹ä»¶ç»‘å®š
			$("#msg_text").on({
				"keydown": function(e) {
					var that = this;
					if (e.ctrlKey && e.keyCode == 13) {
						sendMsg(that.val(), 0);
					}
				},
				"input propertychange": function(e) {
					showSendBtn();
				},
				"focus": function() {
					if ($(".more-content").css('display') != 'none') {
						$(".more-content").hide();
						$("footer").css("bottom", "0");
						$(".im-chat-main").css("padding-bottom", "50px");
						msg_end.scrollIntoView();
						document.getElementById("msg_list").scrollTop = msgList.scrollHeight + msgList.offsetHeight;
					}
				}
			});

			//è¯­éŸ³æŒ‰é’®äº‹ä»¶
			$(".footer-left i.chat-icon-voice").on("tap", function(e) {
				var than = $(this);

				$(".face-content").hide();
				$(".more-content").hide();
				$("footer").css("bottom", "0");
				$(".im-chat-main").css("padding-bottom", "50px");
				$(".footer-right i:first").attr("class", "mui-icon chat-icon chat-icon-face");
				if (than.hasClass("chat-icon-keyboard")) {
					$("#msg_text").show();
					$("footer").css("padding-right", "65px");
					$(".footer-right").css("width", "100px");
					$(".footer-right").css("right", "1px");
					$(".footer-center").css("padding-right", "25px");
					$(".footer-center").css("padding-left", "3px");
					$(".footer-right i:first").show();
					$(".footer-center .voice-btn").hide();
					than.attr("class", "mui-icon chat-icon chat-icon-voice");
					setTimeout(function() {
						$("#msg_text").focus();
					}, 10);
				} else {
					$("#msg_text").hide();
					$("footer").css("padding-right", "55px");
					$(".footer-right").css("width", "initial");
					$(".footer-right").css("right", "5px");
					$(".footer-center").css("padding-right", "0");
					$(".footer-center").css("padding-left", "10px");
					$(".footer-right i:first").hide();
					$(".footer-center .voice-btn").show();
					than.attr("class", "mui-icon chat-icon chat-icon-keyboard");
				}

				document.getElementById("msg_list").scrollTop = msgList.scrollHeight + msgList.offsetHeight;
			});

			//è¡¨æƒ…æŒ‰é’®äº‹ä»¶
			$(".footer-right i.chat-icon-face").on("tap", function(e) {
				var than = $(this);
				var footer = $("footer");

				//éšè—è¯­éŸ³è¾“å…¥
				if ($(".footer-left i:first").hasClass("chat-icon-keyboard")) {
					$(".footer-center .voice-btn").hide();
					$(".footer-left i:first").attr("class", "mui-icon chat-icon chat-icon-voice");
					$("#msg_text").show();
					$("footer").css("padding-right", "65px");
					$(".footer-right").css("width", "100px");
					$(".footer-right").css("right", "1px");
					$(".footer-center").css("padding-right", "25px");
					$(".footer-center").css("padding-left", "3px");
					$(".footer-right i:first").show();
				}

				if (than.hasClass("chat-icon-keyboard")) {
					$(".face-content").hide();
					than.attr("class", "mui-icon chat-icon chat-icon-face");
					footer.css("bottom", "0");
					$(".im-chat-main").css("padding-bottom", "50px");
					setTimeout(function() {
						$("#msg_text").focus();
					}, 10);
				} else {
					$(".more-content").hide();
					$(".face-content").show();
					than.attr("class", "mui-icon chat-icon chat-icon-keyboard");
					footer.css("bottom", $(".face-content").height());
					$(".im-chat-main").css("padding-bottom", $(".face-content").height() + 50);
				}

				document.getElementById("msg_list").scrollTop = msgList.scrollHeight + msgList.offsetHeight;
			});

			//ç»‘å®šè¡¨æƒ…ç‚¹å‡»äº‹ä»¶
			$(".face-content").find('.face-list>li').on('tap', function() {
				focusInsert(boxMsgText, this.title + ' ');
				showSendBtn();
			});

			//æ›´å¤šæŒ‰é’®äº‹ä»¶
			$(".footer-right i.chat-icon-add-more").on("tap", function(e) {
				var than = $(this);
				var footer = $("footer");

				//éšè—è¯­éŸ³è¾“å…¥
				if ($(".footer-left i:first").hasClass("chat-icon-keyboard")) {
					$(".footer-center .voice-btn").hide();
					$(".footer-left i:first").attr("class", "mui-icon chat-icon chat-icon-voice");
					$("#msg_text").show();
					$("footer").css("padding-right", "65px");
					$(".footer-right").css("width", "100px");
					$(".footer-right").css("right", "1px");
					$(".footer-center").css("padding-right", "25px");
					$(".footer-center").css("padding-left", "3px");
					$(".footer-right i:first").show();
				}

				//ä¸ºäº†ç¾è§‚æŠŠæ›´å¤šçš„é«˜åº¦è®¾ç½®æˆè¡¨æƒ…ä¸€æ ·
				$(".more-content").height($(".face-content").height());

				//è¡¨æƒ…æ˜¯å±•å¼€çš„åˆ™éšè—
				if (than.prev().hasClass("chat-icon-keyboard")) {
					than.prev().attr("class", "mui-icon chat-icon chat-icon-face");
				}

				if ($(".more-content").css('display') != 'none') {
					$(".more-content").hide();
					footer.css("bottom", "0");
					$(".im-chat-main").css("padding-bottom", "50px");
				} else {
					$(".face-content").hide();
					$(".more-content").show();
					footer.css("bottom", $(".more-content").height());
					$(".im-chat-main").css("padding-bottom", $(".more-content").height() + 50);
				}

				document.getElementById("msg_list").scrollTop = msgList.scrollHeight + msgList.offsetHeight;
			});

			//ç‚¹å‡»æ¶ˆæ¯åˆ—è¡¨ï¼Œå…³é—­é”®ç›˜
			$("#msg_list").on('tap', function(event) {
				if (!focus) {
					boxMsgText.blur();
				}
				//è¡¨æƒ…æ˜¯å±•å¼€çš„åˆ™éšè—
				if ($(".footer-right i:first").hasClass("chat-icon-keyboard")) {
					$(".footer-right i:first").attr("class", "mui-icon chat-icon chat-icon-face");
				}
				$(".face-content").hide();
				$(".more-content").hide();
				$("footer").css("bottom", "0");
				$(".im-chat-main").css("padding-bottom", "50px");

				document.getElementById("msg_list").scrollTop = msgList.scrollHeight + msgList.offsetHeight;
			});


		});

		//æ˜¾ç¤ºæˆ–éšè—å‘é€æŒ‰é’®
		function showSendBtn() {
			//å¤„ç†æ˜¯å¦æ˜¾ç¤ºå‘é€æ¶ˆæ¯æŒ‰é’®
			if ($("#msg_text").val()) {
				$("#sendMessage").removeClass("mui-hidden");
				$(".footer-right i.chat-icon-add-more").addClass("mui-hidden");
			} else {
				$("#sendMessage").addClass("mui-hidden");
				$(".footer-right i.chat-icon-add-more").removeClass("mui-hidden");
			}
		}

		//åœ¨ç„¦ç‚¹å¤„æ’å…¥å†…å®¹
		function focusInsert(obj, str) {
			var result, val = obj.value;
			obj.focus();
			if (document.selection) { //ie
				result = document.selection.createRange();
				document.selection.empty();
				result.text = str;
			} else {
				result = [
					val.substring(0, obj.selectionStart),
					str,
					val.substr(obj.selectionEnd)
				];
				obj.focus();
				obj.value = result.join('');
			}
		}

		//è½¬æ¢å†…å®¹
		function imContent(content) {
			//æ”¯æŒçš„htmlæ ‡ç­¾
			var html = function(end) {
				return new RegExp('\\n*\\[' + (end || '') +
					'(pre|div|p|table|thead|th|tbody|tr|td|ul|li|ol|li|dl|dt|dd|h2|h3|h4|h5)([\\s\\S]*?)\\]\\n*', 'g');
			};
			content = (content || '').replace(/&(?!#?[a-zA-Z0-9]+;)/g, '&amp;')
				.replace(/face\[([^\s\[\]]+?)\]/g, function(face) { //è½¬ä¹‰è¡¨æƒ…
					var alt = face.replace(/^face/g, '');
					return '<img alt="' + alt + '" title="' + alt + '" src="' + faces[alt] + '">';
				}).replace(/a\([\s\S]+?\)\[[\s\S]*?\]/g, function(str) { //è½¬ä¹‰é“¾æ¥
					var href = (str.match(/a\(([\s\S]+?)\)\[/) || [])[1];
					var text = (str.match(/\)\[([\s\S]*?)\]/) || [])[1];
					if (!href)
						return str;
					return '<a href="' + href + '" target="_blank">' + (text || href) + '</a>';
				}).replace(html(), '\<$1 $2\>').replace(html('/'), '\</$1\>') //è½¬ç§»ä»£ç 
				.replace(/\n/g, '<br>') //è½¬ä¹‰æ¢è¡Œ 
			return content;
		}
		/**
		 * è·å–å½“å‰æ—¶é—´
		 */
		function getNowFormatDate() {
			var date = new Date();
			var seperator1 = "-";
			var seperator2 = ":";
			var month = date.getMonth() + 1;
			var strDate = date.getDate();
			if (month >= 1 && month <= 9) {
				month = "0" + month;
			}
			if (strDate >= 0 && strDate <= 9) {
				strDate = "0" + strDate;
			}
			var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate +
				" " + date.getHours() + seperator2 + date.getMinutes() +
				seperator2 + date.getSeconds();
			return currentdate;
		}
	</script>
	<script>
		var msgs = [];
		var heads = {
			"self": "../../img/zhan.jpg",
			"sz": "../../img/head.png"
		};
		//
		function addMsg(msg, callback) {
			//console.log(msg.content)
			if (msg.content && msg.content != "") {
				msgs.push(msg);
				if (bindMsgs) {
					bindMsgs(true);
				}
			}
		};
		//
		function bindMsgs(endMsg) {
			var html = '';
			var oldtimestamp=0
			msgs.forEach(function(v, i) {
				var head = heads["sz"]
				if (v.sender == 'self') {
					html += '<li class="im-chat-mine">'
					head = heads["self"]
				} else {
					html += '<li>'
				}
				if (!v.time) {
					v.time = ''
				}
				var date = v.time.substring(0, 19);
				date = date.replace(/-/g, '/');
				var timestamp = new Date(date).getTime();
				if (oldtimestamp==0){
					oldtimestamp=timestamp
				}else{
					if (timestamp-oldtimestamp<3600000){
						v.time = ''
					}
				}
				html += '<p class="send-time">' + v.time + '</p>' +
					'<div class="im-chat-user">' +
					'<img src="' + head + '" />' +
					'<cite></cite>' +
					'</div>' +
					'<div class="im-chat-text">' + v.content + '</div>' +
					'</li>';

			});
			msgList.innerHTML = html
			if (endMsg) {
				msg_end.scrollIntoView();
			}
		};


		//å‘é€å›¾ç‰‡
		(function($, doc) {
			$.plusReady(function() {
				pullupRefresh()
				//å‘é€æŒ‰é’®äº‹ä»¶
				document.getElementById('sendMessage').addEventListener("tap", function() {
					var content = jQuery("#msg_text").val();
					console.log(content)
					if (content == "") {
						return
					}
					content = imContent(content)
					var msg = {
						sender: "self",
						type: "text",
						content: content,
						time: ""
					}
					msgs.push(msg)
					bindMsgs(true)

					//æ¸…ç©º
					jQuery("#msg_text").val('')
					showSendBtn();
					var indexPage = plus.webview.getLaunchWebview();
					var ws = plus.webview.currentWebview();
					VG.method(indexPage, "sendMsg", {
						fromJid: ws.selfUser,
						toJid: ws.sid,
						msg: content
					}, function(back) {

					});
				});


				document.getElementById('getImg').addEventListener('tap', function(event) {
					var btnArray = [{
						title: "æ‹ç…§"
					}, {
						title: "ä»ç›¸å†Œé€‰æ‹©"
					}];
					plus.nativeUI.actionSheet({
						title: "é€‰æ‹©ç…§ç‰‡",
						cancel: "å–æ¶ˆ",
						buttons: btnArray
					}, function(e) {
						var index = e.index;
						switch (index) {
							case 0:
								break;
							case 1:
								var cmr = plus.camera.getCamera();
								cmr.captureImage(function(path) {
									console.log('aaaa' + path);
									/*send({
										sender: 'self',
										type: 'image',
										content: "file://" + plus.io.convertLocalFileSystemURL(path)
									});*/
									var ImgPath = "file://" + plus.io.convertLocalFileSystemURL(path);
									var html = '<li class="im-chat-mine">' +
										'<p class="send-time">' + getNowFormatDate() + '</p>' +
										'<div class="im-chat-user">' +
										'<img src="images/ke.jpg" />' +
										'<cite>ç§‘æ¯”</cite>' +
										'</div>' +
										'<div class="im-chat-text">' + '<img class="msg-content-image" src=' + ImgPath + ' />' + '</div>' +
										'</li>';

									//è¿½åŠ å†…å®¹
									msgList.insertAdjacentHTML('beforeEnd', html);

								}, function(err) {});
								break;
							case 2:
								plus.gallery.pick(function(path) {
									console.log('bbbb' + path);
									/*send({
										sender: 'self',
										type: 'image',
										content: path
									});*/
									var html = '<li class="im-chat-mine">' +
										'<p class="send-time">' + getNowFormatDate() + '</p>' +
										'<div class="im-chat-user">' +
										'<img src="images/ke.jpg" />' +
										'<cite>ç§‘æ¯”</cite>' +
										'</div>' +
										'<div class="im-chat-text">' + '<img class="msg-content-image" src=' + path + ' />' + '</div>' +
										'</li>';

									//è¿½åŠ å†…å®¹
									msgList.insertAdjacentHTML('beforeEnd', html);
								}, function(err) {}, null);
								break;
						}
					});
				}, false);
			});
		}(mui, document));
	</script>

</html>
